<script type="text/discourse-plugin" version="0.8">

    const { isEmpty } = require("@ember/utils");
    const EmberObject = require("@ember/object").default;
    
    //Required User Fields Ids
    const COUNTRY_FIELD_ID = 5;
    const STATE_FIELD_ID = 1;
    const PROVINCE_FIELD_ID = 16;
    const FIRST_NAME_FIELD_ID = 6;
    const LAST_NAME_FIELD_ID = 7;
    const COMPANY_FIELD_ID = 8; 
    
    //Required Country and Sate/Province Fields values
    const USA = "usa";
    const CANADA = "canada";
    const INTERNATIONAL = "International";
    
    let firstname, lastname;
    
    //-----------------------------------------[ combo-box component ]---------------------------------------------------------------------
    //Modify combo-box component to add Country logic for State and Province on Create Account page [By Webdirekt on 12-11-2020]
    api.modifyClass('component:combo-box',{
          //Modified by Webdirket on 28-01-2021 (We have replaced the onChange action method by _onChange method)
            //_onChange method to hide/show State/Province User Field based on selected Country 
            _onChange(value) {
                let currentUserFieldId = this.userFieldId;
                if(currentUserFieldId){
                    //If Current user fields is Country
                    if(currentUserFieldId == COUNTRY_FIELD_ID){
                        //If Country is USA, then show State dropdown and hide Province dropdown
                       if(value){
                        if(value.toLowerCase() == USA){
                            $(".user-field-state").show(); 
                            $(".user-field-province").hide(); 
                        }
                        //If Country is Canada, then show Province dropdown and hide State dropdown
                        else if(value.toLowerCase() == CANADA){
                            $(".user-field-province").show(); 
                            $(".user-field-state").hide(); 
                        }
                        //If Country is not USA or Canada , then hide State and Province dropdowns
                        else{
                            $(".user-field-state").hide();
                            $(".user-field-province").hide();
                        }   
                       }
                       //If Country is Null , then hide State and Province dropdowns
                        else{
                            $(".user-field-state").hide();
                            $(".user-field-province").hide();
                        }
                    }
                }
                return true; 
            },

    });
    //----------------------------------------------------[ END OF: combo-box component ]----------------------------------------------------------
    
    //-----------------------------------------------------[ create-account controller ]-----------------------------------------------------------
    //Modify create-account controller to add Country logic for State and Province on Create Account page [By Webdirekt on 12-11-2020]
    //Modify create-account controller to customize UI of Create User Form [18-11-2020].
    api.modifyClass('controller:create-account',{
        firstNameField : null,
        lastNameField : null,
        companyField: null,
        countryField : null,
        stateField : null,
        provinceField : null,
        wdUserFields: null,
        //Added below method by Webdirket on 12-11-2020
        setValueForStateProvince(field_id, value){
            for (var i in this.userFields) {
             if ((this.userFields[i]).field.id == field_id) {
                (this.userFields[i]).set("value", value);
                break; //Stop this loop, we found it!
             }
            }
        },
        //Added below method by Webdirket on 12-11-2020
        processStateProvinceUserFields(processState){
            let value;
            
            if(processState == "pre"){ //Seting State/Province value before Checking Validation
                value = INTERNATIONAL;
            }
            else{ //Reseting State/Province value if Validation fails
                value = null;
            }
            let userFields = this.userFields;
            if (userFields) {
              userFields = userFields.filterBy("field.required");
            }
            if (!isEmpty(userFields)) {
                //Loop over required user fields
              userFields.find((uf) => {
                const field_id = uf.field.id;
                //If current User Field is Country then set Sate/Provice based on selected Country
                if(field_id && field_id == COUNTRY_FIELD_ID){
                    const val = uf.get("value");
                    if(val){
                        //If Selected Country is USA, set Province as "International" 
                        if(val.toLowerCase() == USA){
                            this.setValueForStateProvince(PROVINCE_FIELD_ID, value);
                        }
                        //If Selected Country is Canada, set State as "International"
                        else if(val.toLowerCase() == CANADA){
                            this.setValueForStateProvince(STATE_FIELD_ID, value);
                        }
                        //If Selected Country is other than USA and Canada, set both State and Province as "International"
                        else{
                            this.setValueForStateProvince(PROVINCE_FIELD_ID, value);
                            this.setValueForStateProvince(STATE_FIELD_ID, value);
                        }   
                    }
                    //If Selected Country is Null, Reset both State and Province
                    else{
                        this.setValueForStateProvince(PROVINCE_FIELD_ID, value);
                        this.setValueForStateProvince(STATE_FIELD_ID, value);
                    } 
                }
                    //Getting Users first and Last name to Generate Users Full name while creating User
                    if(field_id && field_id == FIRST_NAME_FIELD_ID){
                        firstname = uf.get("value");    
                    }
                    if(field_id && field_id == LAST_NAME_FIELD_ID){
                        lastname = uf.get("value");    
                    } 
              });
                //Setting User Full Name [First Name + Last Name ]
                if(firstname && lastname){
                    this.set('accountName', firstname + " " + lastname);       
                } 
            }
            
            
        },
        //Method to Validate First name and Last name
        firstAndLastNameValidation(){
            const firstNameField = this.get("firstNameField");
            const lastNameField = this.get("lastNameField");
            //Validate First name
            if(firstNameField){ 
                const val = firstNameField.get("value");
                 if(!val || isEmpty(val)){
                   return EmberObject.create({
                      failed: true,
                      message: I18n.t("user_fields.required", { name: firstNameField.field.name }),
                      element: firstNameField.field.element,
                    });
                 }
            }
            //Validate Last name
            if(lastNameField){
                const val = lastNameField.get("value");
                 if(!val || isEmpty(val)){
                   return EmberObject.create({
                      failed: true,
                      message: I18n.t("user_fields.required", { name: lastNameField.field.name }),
                      element: lastNameField.field.element,
                    });
                 }
            }
            return EmberObject.create({ ok: true });
        }
        ,
        onShow() {
          if (this.skipConfirmation) {
            this.performAccountCreation().finally(() =>
              this.set("skipConfirmation", false)
            );
          }
          //Setting required User Fields variables before showing create account form.
          if(this.userFields){
               this.set("firstNameField", this.userFields.find(obj => obj.field.id == FIRST_NAME_FIELD_ID));
               this.set("lastNameField", this.userFields.find(obj => obj.field.id == LAST_NAME_FIELD_ID));
               this.set("countryField", this.userFields.find(obj => obj.field.id == COUNTRY_FIELD_ID));
               this.set("stateField", this.userFields.find(obj => obj.field.id == STATE_FIELD_ID));
               this.set("provinceField", this.userFields.find(obj => obj.field.id == PROVINCE_FIELD_ID));
               this.set("companyField", this.userFields.find(obj => obj.field.id == COMPANY_FIELD_ID));
          }
        },
        actions:{
        createAccount() {
                this.clearFlash();
                
                //Added by Webdirekt on 12-11-2020
                //Set the value for State or Province based on Seleted Country.
                this.processStateProvinceUserFields("pre");
                
                const validation = [
                  this.emailValidation,
                  this.usernameValidation,
                  this.nameValidation,
                  this.firstAndLastNameValidation(),//Validating FirstName and Last Name before Password [by Webdirekt on 19-11-2020]
                  this.passwordValidation,
                  this.userFieldsValidation,
                ].find((v) => v.failed);
        
                if (validation) {
                    //Added by Webdirekt on 12-11-2020
                    //Reset State/Province User Field based on Selected Country if any validation Error occurred.
                    this.processStateProvinceUserFields("post");
                    
                  if (validation.message) {
                    this.flash(validation.message, "error");
                  }
        
                  const element = validation.element;
                  if (element.tagName === "DIV") {
                    if (element.scrollIntoView) {
                      element.scrollIntoView();
                    }
                    element.click();
                  } else {
                    element.focus();
                  }
        
                  return;
                }
                
                this.performAccountCreation();
              },
        }
    });
    //------------------------------------------[END OF: create-account controller]----------------------------------------------------------------
    
</script>

 
<!-- Modify user-fields/dropdown component template to add two attributes (filterable and userFieldId) to combo-box [By Webdirekt on 12-11-2020] -->
<script type="text/x-handlebars" data-template-name="components/user-fields/dropdown">
    <label class="control-label" for={{concat "user-" this.elementId}}>
      {{html-safe this.field.name}}
      {{#if this.field.required}}
        <span class="required">*</span>
      {{/if}}
    </label>
    
    <div class="controls">
      {{combo-box
        filterable=true
        id=(concat "user-" this.elementId)
        content=this.field.options
        valueProperty=null
        nameProperty=null
        value=this.value
        none=this.noneLabel
        userFieldId=this.field.id
      }}
      <div class="instructions">{{html-safe this.field.description}}</div>
    </div>

</script>

<!-- Modify modal/create-account component template to hide Full name Fields on Create account page [By Webdirekt on 13-11-2020] -->
<!-- Modify modal/create-account component template to customize UI of Create User Form [18-11-2020] -->
<script type="text/x-handlebars" data-template-name="modal/create-account">
{{#create-account email=accountEmail disabled=submitDisabled action=(action "createAccount")}}
  {{#unless complete}}
    {{plugin-outlet name="create-account-before-modal-body"}}
    {{#d-modal-body title="create_account.title" class=modalBodyClasses}}

      {{#unless hasAuthOptions}}
        {{login-buttons externalLogin=(action "externalLogin")}}
      {{/unless}}

      {{#if skipConfirmation}}
        {{loading-spinner size="large"}}
      {{/if}}

      {{#if showCreateForm}}
        <div class="login-form">
          <form>
            <div>
              <div class="wp-row">
                    <div class="wd-input wp-column">
                        <div class="input create-account-email">
                          <div class="label"><label for="new-account-email">{{i18n "user.email.title"}}</label></div>
                          <div>
                            {{#if emailValidated}}
                              <span class="value">{{accountEmail}}</span>
                            {{else}}
                              {{input type="email" value=accountEmail id="new-account-email" name="email" autofocus="autofocus"}}
                            {{/if}}
                          </div>
                        </div>
        
                        <div class="instructions create-account-email">
                          <div></div>
                          {{input-tip validation=emailValidation id="account-email-validation"}}
                          <div><label>{{i18n "user.email.instructions"}}</label></div>
                        </div>
                    </div>
                    
                    <div class="wd-input wp-column">
                        <div class="input">
                          <div class="label"><label for="new-account-username">{{i18n "user.username.title"}}</label></div>
                          <div>
                            {{#if usernameDisabled}}
                              <span class="value">{{accountUsername}}</span>
                            {{else}}
                              {{input value=accountUsername id="new-account-username" name="username" maxlength=maxUsernameLength autocomplete="discourse"}}
                            {{/if}}
                          </div>
                        </div>
                        <div class="instructions">
                          <div></div>
                          {{input-tip validation=usernameValidation id="username-validation"}}
                          <div><label>{{i18n "user.username.instructions"}}</label></div>
                        </div>
                    </div>
                  
                {{!-- Added new class "hide-new-account-name"  to hide Full Name field on Sign-up page [By Webdirekt 13-11-2020] --}}
                {{#if fullnameRequired}}
                    <div  class="wd-input wp-column">
                      <div class="input hide-new-account-name">
                        <div class="label">
                          <label for="new-account-name">{{i18n "user.name.title"}}</label>
                        </div>
                        <div>
                          {{#if nameDisabled}}
                            <span class="value">{{accountName}}</span>
                          {{else}}
                            {{text-field value=accountName id="new-account-name"}}
                          {{/if}}
                        </div>
                      </div>
                      <div class="instructions hide-new-account-name">
                        <div></div>
                        {{input-tip validation=nameValidation}}
                        <div><label>{{nameInstructions}}</label></div>
                      </div>
                    </div>
                {{/if}}
                </div>
                
                <div class="wp-row">
                  {{#if firstNameField}}
                    <div class="wp-column">
                    {{user-field field=firstNameField.field value=firstNameField.value}}
                    </div>
                  {{/if}}  
                  {{#if lastNameField}}
                    <div class="wp-column">
                    {{user-field field=lastNameField.field value=lastNameField.value}}
                    </div>
                  {{/if}}      
                </div>
                
                {{plugin-outlet
                  name="create-account-before-password"
                  noTags=true
                  args=(hash
                    accountName=accountName
                    accountUsername=accountUsername
                    accountPassword=accountPassword
                    userFields=userFields
                    authOptions=authOptions
                  )
                }}
                
                <div class="wp-row">
                    {{#if passwordRequired}}
                        <div  class="wd-input wp-column">
                          <div class="input">
                            <div class="label"><label for="new-account-password">{{i18n "user.password.title"}}</label></div>
                            <div>
                              {{password-field value=accountPassword type="password" id="new-account-password" capsLockOn=capsLockOn}}
                            </div>
                          </div>
                          <div class="instructions">
                            <div></div>
                            {{input-tip validation=passwordValidation}}
                            <div>
                              <label>{{passwordInstructions}}</label>
                              <div class="caps-lock-warning {{unless capsLockOn "hidden"}}">
                                {{d-icon "exclamation-triangle"}} {{i18n "login.caps_lock_warning"}}
                              </div>
                            </div>
                          </div>
                        </div>
                    {{/if}}
                    
                    <div  class="wd-input">
                        <div class="password-confirmation">
                          <div><label for="new-account-password-confirmation">{{i18n "user.password_confirmation.title"}}</label></div>
                          <div>
                            {{honeypot-input id="new-account-confirmation" autocomplete="new-password" value=accountHoneypot}}
                            {{input value=accountChallenge id="new-account-challenge"}}
                          </div>
                        </div>
                    </div>
                    
                    {{#if companyField}}
                        <div class="wp-column">
                        {{user-field field=companyField.field value=companyField.value}}
                        </div>
                    {{/if}}
                </div>
                
                <div class="wp-row">
                    {{#if countryField}}
                        <div class="wp-column">
                        {{user-field field=countryField.field value=countryField.value}}
                        </div>
                    {{/if}}
                    {{#if stateField}}
                        <div class="wp-column">
                        {{user-field field=stateField.field value=stateField.value}}
                        </div>
                    {{/if}}
                    {{#if provinceField}}
                        <div class="wp-column">
                        {{user-field field=provinceField.field value=provinceField.value}}
                        </div>
                    {{/if}}
                </div>

                {{#if requireInviteCode }}
                    <div  class="wd-input wp-column">
                      <div class="invite-code">
                        <div><label for="invite-code">{{i18n "user.invite_code.title"}}</label></div>
                        <div>
                          {{input value=inviteCode id="inviteCode"}}
                        </div>
                        <div><label>{{i18n "user.invite_code.instructions"}}</label></div>
                      </div>
                    </div>
                {{/if}}

                {{plugin-outlet
                  name="create-account-after-password"
                  noTags=true
                  args=(hash
                    accountName=accountName
                    accountUsername=accountUsername
                    accountPassword=accountPassword
                    userFields=userFields
                  )
                }}
              </div>
            {{!-- Commented User fields so that they will not display [By Webdirekt on 19-11-2020] --}}
            {{!-- 
            {{#if userFields}}
              <div class="user-fields">
                    {{#each userFields as |f|}}
                        {{user-field field=f.field value=f.value}}
                    {{/each}}
              </div>
            {{/if}}
            --}}
          </form>
        </div>
      {{/if}}
    {{/d-modal-body}}

    {{#if showCreateForm}}
      <div class="modal-footer">
        {{d-button
          class="btn-large btn-primary"
          action=(action "createAccount")
          disabled=submitDisabled
          label="create_account.title"
          isLoading=formSubmitted
        }}

        {{#unless hasAuthOptions}}
          {{#d-button class="btn-large" id="login-link" action=(route-action "showLogin") disabled=formSubmitted}}
            {{i18n "log_in"}}
          {{/d-button}}
        {{/unless}}

        <div class="disclaimer">{{html-safe disclaimerHtml}}</div>
      </div>

      {{plugin-outlet name="create-account-after-modal-footer" tagName=""}}
    {{/if}}
  {{/unless}}
{{/create-account}}
</script>
